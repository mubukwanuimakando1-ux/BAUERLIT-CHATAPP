<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BAUERLIT CHATAPP ‚Äì Final</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --brand: #20a28f; --brand-dark: #1a8271; --bg: #f3f4f6; --panel: #ffffff;
      --text: #1f2937; --muted: #6b7280; --accent: #d1fae5; --shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--text); }
    header { background:var(--brand); color:#fff; padding:10px 14px; display:flex; align-items:center; box-shadow:var(--shadow); }
    header button { background:none; border:none; font-size:1.5rem; color:#fff; padding:0; cursor:pointer; margin-left:14px; }
    header h1 { font-size:1.2rem; margin:0; flex-grow:1; }
    #login-page, #chat-page { padding:20px; text-align:center; }
    #chat-page { display:none; }
    .chat-list { display:flex; flex-direction:column; align-items:stretch; gap:10px; padding:20px; }
    .chat-item { background:var(--panel); padding:12px 16px; border-radius:12px; display:flex; align-items:center; cursor:pointer; transition:transform 0.1s ease; box-shadow:var(--shadow); }
    .chat-item:hover { transform: translateY(-2px); }
    .chat-item h2 { margin:0; font-size:1rem; flex-grow:1; text-align:left; }
    .chat-item .status-dot { width:10px; height:10px; border-radius:50%; margin-left:10px; background-color:var(--muted); }
    .chat-item .status-dot.online { background-color:#10b981; }
    .message-box { display:none; flex-direction:column; height:100vh; }
    #messages { flex-grow:1; padding:20px; overflow-y:scroll; display:flex; flex-direction:column; gap:10px; background:var(--bg); }
    .message { display:flex; align-items:flex-start; gap:8px; animation:fadeIn 0.3s ease; }
    .message img.avatar { width:36px; height:36px; border-radius:50%; }
    .message .content-box { max-width:70%; display:flex; flex-direction:column; }
    .message .content { padding:10px 14px; border-radius:18px; line-height:1.4; }
    .message.from-me { justify-content:flex-end; }
    .message.from-me .content { background:var(--accent); color:var(--text); border-bottom-right-radius:4px; }
    .message.from-them .content { background:var(--panel); color:var(--text); border-bottom-left-radius:4px; }
    .message.from-me .content-box { align-items:flex-end; }
    .message.from-them .content-box { align-items:flex-start; }
    .message .message-text { white-space:pre-wrap; }
    .message img, .message video { max-width: 100%; border-radius: 10px; }
    .message-input { display:flex; padding:10px; background:var(--panel); border-top:1px solid #e5e7eb; box-shadow:var(--shadow); }
    .message-input input { flex-grow:1; border:1px solid #d1d5db; border-radius:24px; padding:12px 16px; margin-right:8px; }
    .message-input button { background:var(--brand); border:none; border-radius:50%; width:48px; height:48px; color:#fff; font-size:1.5rem; cursor:pointer; transition:background-color 0.2s ease; }
    .message-input button:hover { background-color:var(--brand-dark); }
    #message-input-form { display: flex; flex-grow: 1; align-items: center; }
    #contact-page { display: none; padding: 20px; }
    #contact-list { display: flex; flex-direction: column; gap: 10px; }
    .contact-item { padding: 12px 16px; background: var(--panel); border-radius: 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; box-shadow:var(--shadow); }
    .contact-item h3 { margin: 0; font-size:1rem; }
    .contact-item img.avatar { width: 48px; height: 48px; border-radius: 50%; }
    .chat-item img.avatar { width: 48px; height: 48px; border-radius: 50%; margin-right: 12px; }
    .login-container, .signup-container { background: var(--panel); padding: 40px 30px; border-radius: 12px; max-width: 400px; margin: 40px auto; box-shadow: var(--shadow); }
    .login-container h2, .signup-container h2 { margin-top: 0; }
    .login-container input, .signup-container input { display: block; width: 100%; margin: 10px 0; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; }
    .login-container button, .signup-container button { width: 100%; padding: 12px; background: var(--brand); color: #fff; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px; transition: background-color 0.2s ease; }
    .login-container button:hover, .signup-container button:hover { background-color: var(--brand-dark); }
    .login-container a, .signup-container a { color: var(--brand); text-decoration: none; display: block; margin-top: 15px; }
    #typing-indicator { margin: 0; font-style: italic; color: #fff; font-size: 0.9rem; }
    .reactions { display: flex; gap: 4px; position: absolute; bottom: -16px; right: 0; background: var(--panel); padding: 2px 6px; border-radius: 10px; border: 1px solid #e5e7eb; box-shadow: var(--shadow); }
    .reaction-emoji { font-size: 0.8rem; cursor: pointer; }
    .message .content-wrapper { position: relative; }
    .reaction-picker { position: absolute; bottom: 50px; left: 0; background: var(--panel); border: 1px solid #ddd; border-radius: 8px; padding: 8px; display: flex; flex-wrap: wrap; gap: 4px; z-index: 10; box-shadow: var(--shadow); }
    .reaction-picker button { font-size: 1.2rem; background: none; border: none; cursor: pointer; padding: 4px; }
    .message-reply { background: rgba(0,0,0,0.05); border-left: 3px solid var(--brand); padding: 6px 10px; border-radius: 6px; margin-bottom: 8px; font-size: 0.9em; color: var(--muted); }
    .message-reply span { font-weight: bold; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>
  <div id="login-page" class="login-container">
    <h2>Login with your email</h2>
    <input type="email" id="email-input" placeholder="Email" />
    <input type="password" id="password-input" placeholder="Password" />
    <button id="login-button">Login</button>
    <button id="signup-button">Sign Up</button>
    <a href="#" id="forgot-password-button">Forgot Password?</a>
  </div>
  <div id="chat-page">
    <header id="chat-header">
      <h1 id="header-text">My Chats</h1>
      <button id="add-chat-button">+</button>
      <button id="logout-button">Logout</button>
    </header>
    <div id="chat-list" class="chat-list"></div>
    <div id="message-box" class="message-box">
      <header id="message-header">
        <button id="back-button">&larr;</button>
        <div>
          <h1 id="chat-title"></h1>
          <p id="typing-indicator"></p>
        </div>
      </header>
      <div id="messages"></div>
      <form id="message-input-form">
        <label for="file-input" id="file-upload-label">üñºÔ∏è</label>
        <input type="file" id="file-input" accept="image/*,video/*" />
        <input type="text" id="message-input" placeholder="Type a message..." autocomplete="off"/>
        <button type="submit" id="send-button">‚Üí</button>
      </form>
    </div>
  </div>
  <div id="contact-page">
    <header>
      <button id="contact-back-button">&larr;</button>
      <h1>Select a Contact</h1>
    </header>
    <div id="contact-list"></div>
    <button id="create-group-chat-button" style="display:none;">Create Group Chat</button>
  </div>

  <script>
    /***** 1) SETUP *****/
    const SUPABASE_URL = 'https://vlbebvnoadcpkkrrdjiq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZsYmVidm5vYWRjcGtrcnJkamlxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0ODI0ODQsImV4cCI6MjA3MjA1ODQ4NH0.uVzfaVMu7M8HdkpxbLeYzFFwwYWADt_97h0dz1pFiTo';
    const { createClient } = supabase;
    const client = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUserId = null;
    let currentChatId = null;
    let messageSubscription = null;
    let presenceSubscription = null;
    let typingTimeout = null;
    let typingStatus = false;
    let selectedContacts = [];

    /***** 2) UI ELEMENTS *****/
    const pages = {
      login: document.getElementById('login-page'),
      chat: document.getElementById('chat-page'),
      contact: document.getElementById('contact-page'),
      messageBox: document.getElementById('message-box'),
    };
    const ui = {
      emailInput: document.getElementById('email-input'),
      passwordInput: document.getElementById('password-input'),
      loginButton: document.getElementById('login-button'),
      signupButton: document.getElementById('signup-button'),
      forgotPasswordButton: document.getElementById('forgot-password-button'),
      logoutButton: document.getElementById('logout-button'),
      chatList: document.getElementById('chat-list'),
      messages: document.getElementById('messages'),
      messageInput: document.getElementById('message-input'),
      messageInputForm: document.getElementById('message-input-form'),
      fileInput: document.getElementById('file-input'),
      chatTitle: document.getElementById('chat-title'),
      backButton: document.getElementById('back-button'),
      addChatButton: document.getElementById('add-chat-button'),
      contactList: document.getElementById('contact-list'),
      contactBackButton: document.getElementById('contact-back-button'),
      typingIndicator: document.getElementById('typing-indicator'),
      createGroupChatButton: document.getElementById('create-group-chat-button'),
    };

    /***** 3) AUTHENTICATION *****/
    async function handleLogin() {
      const { error } = await client.auth.signInWithPassword({
        email: ui.emailInput.value,
        password: ui.passwordInput.value,
      });
      if (error) alert(error.message);
    }

    async function handleSignUp() {
      const { error } = await client.auth.signUp({
        email: ui.emailInput.value,
        password: ui.passwordInput.value,
      });
      if (error) {
        alert(error.message);
      } else {
        alert('Registration successful! Please check your email to confirm your account.');
      }
    }

    async function handleForgotPassword() {
      const email = ui.emailInput.value;
      if (!email) {
        alert('Please enter your email to reset your password.');
        return;
      }
      const { error } = await client.auth.resetPasswordForEmail(email);
      if (error) {
        alert(error.message);
      } else {
        alert('Password reset email sent. Check your inbox!');
      }
    }

    async function handleLogout() {
      if (presenceSubscription) {
        await presenceSubscription.unsubscribe();
      }
      await client.auth.signOut();
    }

    client.auth.onAuthStateChange(async (event, session) => {
      if (session) {
        currentUserId = session.user.id;
        showPage('chat');
        await loadChats();
        await loadContacts();
        await setupPresence();
      } else {
        currentUserId = null;
        showPage('login');
        if (messageSubscription) {
          messageSubscription.unsubscribe();
          messageSubscription = null;
        }
      }
    });

    /***** 4) DATA OPERATIONS *****/
    async function setupPresence() {
      const status = { user_id: currentUserId, is_typing: false, updated_at: new Date().toISOString() };
      presenceSubscription = client.channel('status', { config: { presence: { key: currentUserId } } })
        .on('presence', { event: 'sync' }, () => {
          const presenceState = presenceSubscription.presenceState();
          updateChatListStatus(presenceState);
          updateTypingIndicator(presenceState);
        })
        .subscribe(async (status) => {
          if (status === 'SUBSCRIBED') {
            await presenceSubscription.track(status);
          }
        });
    }

    async function loadChats() {
      ui.chatList.innerHTML = '';
      const { data: chats, error } = await client
        .from('chats')
        .select('*')
        .contains('participants', [currentUserId])
        .order('last_updated', { ascending: false });
      if (error) {
        console.error('Error fetching chats:', error);
        return;
      }
      for (const chat of chats) {
        const otherParticipantIds = chat.participants.filter(id => id !== currentUserId);
        const { data: usersData } = await client.from('users').select('email, display_name, avatar_url').in('id', otherParticipantIds);
        
        let chatTitle = 'Group Chat';
        let avatarUrl = 'https://ui-avatars.com/api/?name=Group';
        
        if (usersData.length === 1) {
            chatTitle = usersData[0].display_name || usersData[0].email.split('@')[0];
            avatarUrl = usersData[0].avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(chatTitle)}`;
        } else if (usersData.length > 1) {
            chatTitle = usersData.map(u => u.display_name || u.email.split('@')[0]).join(', ');
        }
        
        const chatItem = document.createElement('div');
        chatItem.className = 'chat-item';
        chatItem.innerHTML = `<img src="${avatarUrl}" class="avatar" /><h2>${chatTitle}</h2><span class="status-dot" id="dot-${chat.id}"></span>`;
        chatItem.onclick = () => openChat(chat.id, chatTitle);
        ui.chatList.appendChild(chatItem);
      }
    }

    async function sendMessage(text, file, replyToId = null) {
      if (!currentChatId || (!text.trim() && !file)) return;
      let messageContent = text.trim();
      let messageType = 'text';
      if (file) {
        messageType = file.type.startsWith('image/') ? 'image' : 'video';
        const fileExtension = file.name.split('.').pop();
        const filePath = `${currentUserId}/${Date.now()}.${fileExtension}`;
        const { data: uploadData, error: uploadError } = await client.storage.from('chat_media').upload(filePath, file);
        if (uploadError) {
          console.error('File upload error:', uploadError);
          return;
        }
        const { data: publicUrlData } = client.storage.from('chat_media').getPublicUrl(filePath);
        messageContent = publicUrlData.publicUrl;
      }
      
      const { error } = await client
        .from('messages')
        .insert({
          chat_id: currentChatId,
          sender_id: currentUserId,
          type: messageType,
          content: messageContent,
          reply_to_message_id: replyToId
        });
      if (error) {
        console.error('Error sending message:', error);
      } else {
        ui.messageInput.value = '';
        ui.fileInput.value = '';
      }
    }

    async function deleteMessage(messageId) {
        const { error } = await client
            .from('messages')
            .delete()
            .eq('id', messageId)
            .eq('sender_id', currentUserId);
        if (error) {
            console.error('Error deleting message:', error);
        } else {
            document.getElementById(`msg-${messageId}`).remove();
        }
    }

    async function openChat(chatId, chatTitle) {
      currentChatId = chatId;
      ui.chatTitle.innerText = chatTitle;
      pages.messageBox.style.display = 'flex';
      ui.chatList.style.display = 'none';
      pages.contact.style.display = 'none';

      if (messageSubscription) {
        messageSubscription.unsubscribe();
      }
      await loadMessages();
      
      messageSubscription = client
        .channel(`chat_messages_${currentChatId}`)
        .on(
          'postgres_changes',
          { event: '*', schema: 'public', table: 'messages', filter: `chat_id=eq.${currentChatId}` },
          (payload) => {
            if (payload.eventType === 'INSERT') {
              appendMessage(payload.new);
            } else if (payload.eventType === 'DELETE') {
              document.getElementById(`msg-${payload.old.id}`).remove();
            }
          }
        )
        .subscribe();
    }

    async function loadMessages() {
      ui.messages.innerHTML = '';
      const { data: messages, error } = await client
        .from('messages')
        .select(`
            *,
            reactions (*),
            reply_to_message:messages(id, content, sender_id, sender:users(display_name))
        `)
        .eq('chat_id', currentChatId)
        .order('created_at', { ascending: true });
      if (error) {
        console.error('Error fetching messages:', error);
        return;
      }
      messages.forEach(appendMessage);
      ui.messages.scrollTop = ui.messages.scrollHeight;
    }

    async function loadContacts() {
      ui.contactList.innerHTML = '';
      selectedContacts = [];
      ui.createGroupChatButton.style.display = 'none';
      const { data: users, error } = await client
        .from('users')
        .select('id, email, display_name, avatar_url')
        .neq('id', currentUserId);
      if (error) {
        console.error('Error fetching contacts:', error);
        return;
      }
      for (const user of users) {
        const contactItem = document.createElement('div');
        contactItem.className = 'contact-item';
        const avatarUrl = user.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.display_name || user.email)}`;
        contactItem.innerHTML = `<img src="${avatarUrl}" class="avatar" /><h3>${user.display_name || user.email.split('@')[0]}</h3>`;
        contactItem.onclick = () => {
          if (selectedContacts.includes(user.id)) {
            selectedContacts = selectedContacts.filter(id => id !== user.id);
            contactItem.style.border = 'none';
          } else {
            selectedContacts.push(user.id);
            contactItem.style.border = '2px solid var(--brand)';
          }
          if (selectedContacts.length === 1) {
            createChatWith(selectedContacts[0]);
          }
          ui.createGroupChatButton.style.display = selectedContacts.length > 1 ? 'block' : 'none';
        };
        ui.contactList.appendChild(contactItem);
      }
    }

    async function createChatWith(participantIds) {
      if (!Array.isArray(participantIds)) {
        participantIds = [participantIds];
      }
      participantIds.push(currentUserId);
      const { data: newChat, error: creationError } = await client
        .from('chats')
        .insert({
          participants: participantIds,
        }).select();
      if (creationError) {
        console.error('Error creating new chat:', creationError);
      } else {
        const chatTitle = "New Chat"; // A more complex title could be generated here
        openChat(newChat[0].id, chatTitle);
      }
    }

    async function addReaction(messageId, emoji) {
        const { error } = await client.from('reactions').insert({
            message_id: messageId,
            user_id: currentUserId,
            emoji: emoji
        });
        if (error) console.error("Error adding reaction:", error);
    }
    
    /***** 5) UI LOGIC & HELPERS *****/
    function showPage(pageName) {
      for (const page in pages) {
        pages[page].style.display = 'none';
      }
      pages[pageName].style.display = 'block';
      if (pageName === 'chat') {
        ui.chatList.style.display = 'flex';
        pages.messageBox.style.display = 'none';
      }
    }

    function appendMessage(p) {
      const box = document.createElement('div');
      box.id = `msg-${p.id}`;
      box.className = 'message ' + (p.sender_id === currentUserId ? 'from-me' : 'from-them');

      const contentWrapper = document.createElement('div');
      contentWrapper.className = 'content-wrapper';

      const contentBox = document.createElement('div');
      contentBox.className = 'content';
      
      if (p.reply_to_message_id) {
        const replyEl = document.createElement('div');
        replyEl.className = 'message-reply';
        const senderName = p.reply_to_message.sender ? p.reply_to_message.sender.display_name : 'Unknown';
        replyEl.innerHTML = `Replying to <span>${senderName}</span><br>${p.reply_to_message.content}`;
        contentBox.appendChild(replyEl);
      }

      if(p.type==='text'){
        const text = document.createElement('div');
        text.className = 'message-text';
        text.innerText = p.content;
        contentBox.appendChild(text);
      } else if (p.type === 'image') {
        const img = document.createElement('img');
        img.src = p.content;
        contentBox.appendChild(img);
      } else if (p.type === 'video') {
        const video = document.createElement('video');
        video.src = p.content;
        video.controls = true;
        contentBox.appendChild(video);
      }
      
      contentWrapper.appendChild(contentBox);
      box.appendChild(contentWrapper);
      ui.messages.appendChild(box);
      ui.messages.scrollTop = ui.messages.scrollHeight;
    }

    function updateChatListStatus(presenceState) {
        for (const [key, value] of Object.entries(presenceState)) {
            const userIsOnline = value.some(track => track.user_id);
            const dot = document.getElementById(`dot-${key}`);
            if (dot) {
                dot.classList.toggle('online', userIsOnline);
            }
        }
    }

    function updateTypingIndicator(presenceState) {
        const currentChatUsers = presenceSubscription.presenceState();
        const typingUsers = Object.entries(currentChatUsers)
            .filter(([key, value]) => key !== currentUserId && value.some(u => u.is_typing));
        if (typingUsers.length > 0) {
            ui.typingIndicator.innerText = `${typingUsers.length === 1 ? 'is' : 'are'} typing...`;
        } else {
            ui.typingIndicator.innerText = '';
        }
    }

    /***** 6) EVENT LISTENERS *****/
    ui.loginButton.addEventListener('click', handleLogin);
    ui.signupButton.addEventListener('click', handleSignUp);
    ui.forgotPasswordButton.addEventListener('click', handleForgotPassword);
    ui.logoutButton.addEventListener('click', handleLogout);
    ui.messageInput.addEventListener('input', () => {
      if (!typingStatus) {
        presenceSubscription.track({ user_id: currentUserId, is_typing: true });
        typingStatus = true;
      }
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
        presenceSubscription.track({ user_id: currentUserId, is_typing: false });
        typingStatus = false;
      }, 3000);
    });
    ui.messageInputForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const file = ui.fileInput.files[0];
      const messageText = ui.messageInput.value;
      sendMessage(messageText, file);
    });
    ui.backButton.addEventListener('click', () => {
      pages.messageBox.style.display = 'none';
      ui.chatList.style.display = 'flex';
      currentChatId = null;
      if (messageSubscription) {
        messageSubscription.unsubscribe();
        messageSubscription = null;
      }
    });
    ui.addChatButton.addEventListener('click', () => {
      showPage('contact');
    });
    ui.contactBackButton.addEventListener('click', () => {
      showPage('chat');
    });
    ui.createGroupChatButton.addEventListener('click', () => {
      createChatWith(selectedContacts);
    });
  </script>
</body>
</html>
